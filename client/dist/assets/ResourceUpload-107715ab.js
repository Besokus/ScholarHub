import{d as se,u as te,r as i,j as e,C as ae,B as re,m as g,L as ie,R as le}from"./index-742c88f7.js";import{C as ne}from"./courses-cf5571ad.js";import{U as oe}from"./uploads-caafdb77.js";import{R as ce}from"./RichText-8c20a8cd.js";import{A as de}from"./arrow-left-83ee801f.js";import{L as xe}from"./layers-ac6640bf.js";import{C as w}from"./cloud-upload-81968a74.js";import{C as I}from"./circle-check-135a219a.js";import{Z as me}from"./zap-d32f4ce6.js";import{F as X,a as pe}from"./file-151d33f9.js";import{T as he}from"./trash-2-756d9edf.js";import{T as ue}from"./type-07a2c041.js";import{F as G}from"./file-text-ca3a3a77.js";import{A as O}from"./index-7dbfdcd6.js";import{C as fe}from"./circle-alert-dad2e7a8.js";import{X as ge}from"./x-551ee725.js";import{I as be}from"./image-703b1c2d.js";import{P as je,M as Ne}from"./package-8be94a66.js";import{S as ve}from"./send-d827c15e.js";import"./eye-6021bed5.js";const B={pdf:"PDF",jpg:"JPG",jpeg:"JPG",png:"PNG",gif:"GIF",zip:"ZIP",rar:"RAR","7z":"7Z",docx:"DOCX",doc:"DOC",pptx:"PPTX",ppt:"PPT",xlsx:"XLSX",xls:"XLS",txt:"TXT",mp3:"MP3",mp4:"MP4"};function Be(){const{show:y}=se(),P=te(),[o,z]=i.useState(""),[x,F]=i.useState(""),[p,C]=i.useState(""),[Z,E]=i.useState([]),[r,S]=i.useState(null),[d,R]=i.useState(""),[m,T]=i.useState(null),[$,J]=i.useState(!1),[b,h]=i.useState(""),[u,k]=i.useState(!1),[D,N]=i.useState(!1),j=i.useRef(null),c=i.useMemo(()=>o.length>0&&String(p).length>0&&x.length>0,[o,p,x]),K=async s=>new Promise(t=>{const a=new FileReader;a.onloadend=n=>{var U;const f=new Uint8Array((U=n.target)==null?void 0:U.result).subarray(0,4);let l="";for(let v=0;v<f.length;v++)l+=f[v].toString(16).toUpperCase().padStart(2,"0")+" ";l=l.trim(),l.startsWith("50 4B 03 04")?t("ZIP/DOCX/XLSX/PPTX"):l.startsWith("52 61 72 21")?t("RAR"):l.startsWith("37 7A BC AF")?t("7Z"):l.startsWith("25 50 44 46")?t("PDF"):l.startsWith("FF D8 FF")?t("JPG"):l.startsWith("89 50 4E 47")?t("PNG"):l.startsWith("47 49 46 38")?t("GIF"):l.startsWith("49 44 33")||l.startsWith("FF FB")?t("MP3"):l.startsWith("00 00 00")&&(s.type==="video/mp4"||s.name.endsWith(".mp4"))?t("MP4"):t("UNKNOWN")},a.readAsArrayBuffer(s.slice(0,262))}),A=s=>{if(s===0)return"0 B";const t=1024,a=["B","KB","MB","GB"],n=Math.floor(Math.log(s)/Math.log(t));return parseFloat((s/Math.pow(t,n)).toFixed(2))+" "+a[n]},_=()=>!o||o.length>100?"标题需填写且不超过100字":!x||x.length>2e3?"简介需填写且不超过2000字":p?r&&r.size>50*1024*1024?"文件大小超过50MB":"":"请选择课程";i.useEffect(()=>{ne.list().then(s=>{const t=s.items||[];E(t),t.length&&C(t[0].id)}).catch(()=>{})},[]),i.useEffect(()=>()=>{m&&URL.revokeObjectURL(m)},[m]);const W=async s=>{var f;const t=await K(s);let a=((f=s.name.split(".").pop())==null?void 0:f.toLowerCase())||"",n=B[a]||"UNKNOWN";t==="ZIP/DOCX/XLSX/PPTX"?n=["docx","xlsx","pptx","zip"].includes(a)?B[a]:"ZIP":t!=="UNKNOWN"&&["RAR","7Z","PDF","JPG","PNG","GIF"].includes(t)&&(n=t),h(n==="UNKNOWN"?"警告：无法识别文件类型，或文件类型不支持":""),S(s),R(n),T(s.type.startsWith("image/")||s.type==="application/pdf"?URL.createObjectURL(s):null)},H=async s=>{var a;const t=(a=s.target.files)==null?void 0:a[0];t&&await W(t)},Y=s=>{s.preventDefault(),N(!0)},q=s=>{s.preventDefault(),N(!1)},Q=async s=>{var a;s.preventDefault(),N(!1);const t=(a=s.dataTransfer.files)==null?void 0:a[0];t&&await W(t)},L=()=>{S(null),R(""),T(null),j.current&&(j.current.value="")},V=async()=>{const s=_();if(s){h(s);return}k(!0);try{let t={};if(r){const a=await oe.uploadFile(r);t={fileUrl:a.url,type:d||a.type,size:A(r.size)}}await le.create({title:o,summary:x,courseId:Number(p),...t}),h("发布成功"),y("发布成功","success");try{window.dispatchEvent(new CustomEvent("SH_STATS_UPDATED"))}catch{}z(""),F(""),L(),setTimeout(()=>{try{P("/student/resources",{replace:!0})}catch{}},500)}catch{h("发布失败"),y("发布失败","error")}finally{k(!1)}},ee=()=>r?d==="PDF"?e.jsx(G,{className:"text-rose-500",size:32}):["JPG","PNG","GIF"].includes(d)?e.jsx(be,{className:"text-purple-500",size:32}):["ZIP","RAR","7Z"].includes(d)?e.jsx(je,{className:"text-amber-500",size:32}):["MP4"].includes(d)?e.jsx(pe,{className:"text-sky-500",size:32}):["MP3"].includes(d)?e.jsx(Ne,{className:"text-emerald-500",size:32}):e.jsx(X,{className:"text-slate-500",size:32}):null,M=({isMobile:s=!1})=>e.jsxs(g.button,{onClick:V,disabled:u||!c&&!s,whileHover:!u&&c?{scale:1.05,boxShadow:"0 10px 25px -5px rgba(79, 70, 229, 0.4)"}:{},whileTap:!u&&c?{scale:.95}:{},className:`
        relative overflow-hidden group flex items-center justify-center gap-2 rounded-xl font-bold transition-all duration-300
        ${s?"w-full py-3 px-6 text-sm":"px-8 py-3"}
        ${c?"bg-gradient-to-r from-indigo-600 to-indigo-500 text-white shadow-lg shadow-indigo-200":"bg-slate-100 text-slate-400 cursor-not-allowed"}
      `,children:[c&&!u&&e.jsx("div",{className:"absolute inset-0 bg-white/20 translate-x-[-100%] group-hover:translate-x-[100%] transition-transform duration-700 skew-x-12"}),u?e.jsxs(e.Fragment,{children:[e.jsx(ie,{size:18,className:"animate-spin"}),e.jsx("span",{children:"处理中..."})]}):e.jsxs(e.Fragment,{children:[c?e.jsx(ve,{size:18}):e.jsx(w,{size:18}),e.jsx("span",{children:c?"发布资源":"请完善信息"})]})]});return e.jsxs("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 py-8 min-h-screen",children:[e.jsxs("div",{className:"flex flex-col md:flex-row md:items-end justify-between gap-6 mb-8",children:[e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-3 text-sm text-slate-500 font-medium mb-3",children:[e.jsx("button",{onClick:()=>P(-1),className:"p-1.5 rounded-lg hover:bg-slate-100 hover:text-slate-700 transition-colors",title:"返回",children:e.jsx(de,{size:16})}),e.jsx("div",{className:"w-px h-3 bg-slate-300"}),e.jsxs("span",{className:"flex items-center gap-1 hover:text-indigo-600 cursor-pointer transition-colors",children:[e.jsx(xe,{size:14})," 资源中心"]}),e.jsx(ae,{size:14,className:"opacity-50"}),e.jsx("span",{className:"text-indigo-600 font-semibold bg-indigo-50 px-2 py-0.5 rounded-md",children:"发布"})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-3 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl text-white shadow-lg shadow-indigo-200",children:e.jsx(w,{size:24,strokeWidth:2.5})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-extrabold text-slate-900 tracking-tight",children:"分享资源"}),e.jsx("p",{className:"text-slate-500 text-sm mt-1 flex items-center gap-2",children:c?e.jsxs("span",{className:"text-emerald-600 flex items-center gap-1 font-medium animate-in fade-in",children:[e.jsx(I,{size:14})," 准备就绪"]}):e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(me,{size:14,className:"text-amber-500"}),"填写标题和简介即可发布"]})})]})]})]}),e.jsx("div",{className:"hidden md:block",children:e.jsx(M,{})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-12 gap-8 items-start",children:[e.jsxs("div",{className:"lg:col-span-4 space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-[1.5rem] p-6 shadow-sm border border-slate-100",children:[e.jsxs("label",{className:"block text-sm font-bold text-slate-700 mb-3 flex items-center gap-2",children:[e.jsx(re,{size:18,className:"text-indigo-500"})," 所属课程"]}),e.jsx("div",{className:"relative group",children:e.jsx("select",{className:"w-full px-4 py-3.5 bg-slate-50 border border-slate-200 focus:bg-white focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 rounded-xl text-slate-700 appearance-none cursor-pointer transition-all outline-none font-medium pr-10 hover:border-slate-300",value:p,onChange:s=>C(Number(s.target.value)),children:Z.map(s=>e.jsx("option",{value:s.id,children:s.name},s.id))})})]}),e.jsxs("div",{className:"bg-white rounded-[1.5rem] p-6 shadow-sm border border-slate-100 flex flex-col h-full min-h-[300px]",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("label",{className:"text-sm font-bold text-slate-700 flex items-center gap-2",children:[e.jsx(X,{size:18,className:"text-indigo-500"}),"文件附件 ",e.jsx("span",{className:"text-[10px] font-normal text-slate-400 bg-slate-100 px-1.5 py-0.5 rounded",children:"可选"})]}),r&&e.jsx("span",{className:"text-[10px] font-bold bg-emerald-50 text-emerald-600 px-2 py-0.5 rounded-full border border-emerald-100",children:"Ready"})]}),e.jsx("input",{ref:j,type:"file",onChange:H,className:"hidden",accept:".pdf,.doc,.docx,.ppt,.pptx,.xls,.xlsx,.txt,.jpg,.jpeg,.png,.gif,.zip,.rar,.7z,.mp3,.mp4"}),r?e.jsxs(g.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},className:"flex-1 bg-slate-50 border border-slate-200 rounded-2xl p-6 relative flex flex-col items-center justify-center text-center group/file",children:[e.jsx("button",{onClick:L,className:"absolute top-3 right-3 p-2 bg-white text-slate-400 hover:text-rose-500 hover:bg-rose-50 rounded-full transition-colors shadow-sm opacity-0 group-hover/file:opacity-100 transform translate-y-2 group-hover/file:translate-y-0 transition-all z-10",children:e.jsx(he,{size:16})}),e.jsx("div",{className:"w-20 h-20 bg-white rounded-2xl flex items-center justify-center mb-4 shadow-sm ring-4 ring-slate-100/50",children:e.jsx(ee,{})}),e.jsx("h3",{className:"text-sm font-bold text-slate-800 line-clamp-2 px-2 mb-1 break-all",children:r.name}),e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx("span",{className:"text-[10px] font-bold bg-slate-200 text-slate-600 px-2 py-0.5 rounded uppercase",children:d}),e.jsx("span",{className:"text-xs text-slate-400",children:A(r.size)})]})]}):e.jsxs("div",{onDragOver:Y,onDragLeave:q,onDrop:Q,onClick:()=>{var s;return(s=j.current)==null?void 0:s.click()},className:`
                   flex-1 border-2 border-dashed rounded-2xl flex flex-col items-center justify-center p-6 transition-all cursor-pointer group text-center relative overflow-hidden
                   ${D?"border-indigo-500 bg-indigo-50/50 scale-[0.99]":"border-slate-200 bg-slate-50/50 hover:bg-slate-100 hover:border-indigo-400"}
                 `,children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-tr from-transparent via-white/50 to-transparent opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"}),e.jsx("div",{className:`
                   w-14 h-14 rounded-full mb-4 flex items-center justify-center transition-all duration-300 shadow-sm
                   ${D?"bg-indigo-600 text-white scale-110":"bg-white text-indigo-500 group-hover:scale-110 group-hover:bg-indigo-600 group-hover:text-white"}
                 `,children:e.jsx(w,{size:28,strokeWidth:2.5})}),e.jsx("p",{className:"text-sm font-bold text-slate-700 mb-1 group-hover:text-indigo-600 transition-colors",children:"拖拽或点击上传"}),e.jsxs("p",{className:"text-xs text-slate-400 leading-relaxed px-4",children:["仅在需要时上传 ",e.jsx("br",{})," 支持 PDF/Word/ZIP/RAR/7Z 等"]})]})]})]}),e.jsxs("div",{className:"lg:col-span-8 space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-[2rem] p-6 sm:p-8 shadow-sm border border-slate-100 flex flex-col relative min-h-[500px]",children:[e.jsxs("div",{className:"mb-6 relative z-10",children:[e.jsxs("label",{className:"block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2",children:[e.jsx(ue,{size:18,className:"text-indigo-500"})," 资源标题 ",e.jsx("span",{className:"text-rose-500",children:"*"})]}),e.jsxs("div",{className:"relative group",children:[e.jsx("input",{className:"w-full px-5 py-4 bg-slate-50 border border-slate-200 focus:bg-white focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 rounded-2xl text-lg font-bold text-slate-800 placeholder:text-slate-400 transition-all outline-none",placeholder:"请输入标题...",value:o,onChange:s=>z(s.target.value),maxLength:100}),e.jsxs("div",{className:`absolute right-4 bottom-4 text-xs font-mono transition-colors ${o.length>90?"text-amber-500 font-bold":"text-slate-400"}`,children:[o.length,"/100"]})]})]}),e.jsxs("div",{className:"flex flex-col flex-1 relative z-10",children:[e.jsxs("label",{className:"block text-sm font-bold text-slate-700 mb-2 flex items-center gap-2",children:[e.jsx(G,{size:18,className:"text-indigo-500"})," 资源简介 ",e.jsx("span",{className:"text-rose-500",children:"*"})]}),e.jsx("div",{className:"flex-1 min-h-[350px] border border-slate-200 rounded-2xl overflow-hidden focus-within:ring-4 focus-within:ring-indigo-500/10 focus-within:border-indigo-500 transition-all flex flex-col bg-slate-50/30",children:e.jsx(ce,{value:x,onChange:F,maxLength:2e3,className:"h-full"})})]}),e.jsx(O,{children:b&&e.jsxs(g.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0},className:`absolute bottom-6 left-8 z-20 px-4 py-2 rounded-lg text-sm font-medium flex items-center gap-2 shadow-lg backdrop-blur-md border ${b.includes("成功")?"bg-emerald-50/90 text-emerald-700 border-emerald-100":"bg-rose-50/90 text-rose-700 border-rose-100"}`,children:[b.includes("成功")?e.jsx(I,{size:16}):e.jsx(fe,{size:16}),b]})})]}),e.jsx("div",{className:"md:hidden pt-4 pb-8",children:e.jsx(M,{isMobile:!0})})]})]}),e.jsx(O,{children:$&&m&&e.jsx(g.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-md p-4",children:e.jsxs(g.div,{initial:{scale:.95},animate:{scale:1},exit:{scale:.95},className:"bg-white rounded-3xl shadow-2xl max-w-5xl w-full max-h-[85vh] flex flex-col overflow-hidden ring-1 ring-white/20",children:[e.jsxs("div",{className:"flex items-center justify-between px-6 py-4 border-b border-slate-100 bg-slate-50/50",children:[e.jsx("h3",{className:"font-bold text-slate-800 text-sm truncate",children:r==null?void 0:r.name}),e.jsx("button",{onClick:()=>J(!1),className:"p-2 text-slate-400 hover:text-slate-700 hover:bg-slate-200 rounded-full transition-colors",children:e.jsx(ge,{size:20})})]}),e.jsx("div",{className:"flex-1 overflow-auto bg-slate-100 p-4 flex justify-center items-center",children:r!=null&&r.type.startsWith("image/")?e.jsx("img",{src:m,alt:"Preview",className:"max-w-full max-h-full object-contain rounded-lg"}):e.jsx("iframe",{src:m,className:"w-full h-full min-h-[60vh] bg-white rounded-xl shadow-sm border border-slate-200",title:"Preview"})})]})})})]})}export{Be as default};
