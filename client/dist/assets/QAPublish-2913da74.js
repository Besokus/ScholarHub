import{c as R,r as l,j as e,m as A,u as O,b as B,e as F,d as Q,C as V,B as H,L as K,Q as q}from"./index-5b5873b3.js";import{R as Z}from"./RichText-ad1d076c.js";import{X as $}from"./x-07aa51c2.js";import{A as M}from"./arrow-left-700544e9.js";import{A as L}from"./arrow-right-ff43a6c3.js";import{I as E}from"./image-2ccc8df4.js";import{A as D}from"./index-1fea0efe.js";import{U as G}from"./uploads-b96cf77c.js";import{C as J}from"./courses-9130104b.js";import{L as W}from"./layers-3a945354.js";import{P as X}from"./pen-line-15b2c0fb.js";import{T as Y}from"./type-4c1e22a7.js";import{C as U}from"./chevron-down-9d9beabd.js";import{C as ee}from"./circle-alert-b381806f.js";import{S as te}from"./send-4eb22d6d.js";import{S as se}from"./sparkles-4660b4c3.js";import{I as ae}from"./info-11ed3e31.js";import"./eye-7330d154.js";/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const oe=[["path",{d:"M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8",key:"1p45f6"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}]],T=R("rotate-cw",oe);/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"11",x2:"11",y1:"8",y2:"14",key:"1vmskp"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]],re=R("zoom-in",ie);/**
 * @license lucide-react v0.554.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=[["circle",{cx:"11",cy:"11",r:"8",key:"4ej97u"}],["line",{x1:"21",x2:"16.65",y1:"21",y2:"16.65",key:"13gj7c"}],["line",{x1:"8",x2:"14",y1:"11",y2:"11",key:"durymu"}]],le=R("zoom-out",ne);function ce({images:i,onChange:b,maxCount:w=9,initialUrls:c=[],onInitialUrlsChange:g}){var n,_;const[j,p]=l.useState([]),[r,d]=l.useState(null),[f,N]=l.useState(null),[y,m]=l.useState(1),[v,x]=l.useState(0);l.useEffect(()=>{const t=i.map(o=>URL.createObjectURL(o));return p(t),()=>t.forEach(o=>URL.revokeObjectURL(o))},[i]);const z=t=>{const o=Array.from(t.target.files||[]);if(!o.length)return;const a=((c==null?void 0:c.length)||0)+i.length,s=Math.max(0,w-a),h=o.slice(0,s),u=[...i,...h];b(u),t.target.value=""},P=t=>{const o=i.filter((a,s)=>s!==t);b(o),r===t&&C(),r!==null&&r>t&&d(r-1)},I=(t,o)=>{const a=o==="left"?t-1:t+1;if(a<0||a>=i.length)return;const s=[...i],h=s[t];s[t]=s[a],s[a]=h,b(s)},S=t=>{N("initial"),d(t),m(1),x(0)},k=t=>{N("new"),d(t),m(1),x(0)},C=()=>{d(null)};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex flex-wrap gap-4",children:[c.map((t,o)=>e.jsxs("div",{className:"relative group w-28 h-28 border rounded-lg overflow-hidden bg-gray-100 shadow-sm",children:[e.jsx("img",{src:t,alt:`existing ${o}`,className:"w-full h-full object-cover cursor-pointer hover:opacity-90 transition",onClick:()=>S(o)}),e.jsx("div",{className:"absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition flex flex-col justify-between p-1",children:e.jsx("div",{className:"flex justify-end",children:g&&e.jsx("button",{type:"button",onClick:a=>{a.stopPropagation(),g(c.filter((s,h)=>h!==o))},className:"p-1 bg-red-500 text-white rounded-full hover:bg-red-600 transition",title:"删除",children:e.jsx($,{size:12})})})})]},`init-${o}-${t}`)),j.map((t,o)=>{var a;return e.jsxs("div",{className:"relative group w-28 h-28 border rounded-lg overflow-hidden bg-gray-100 shadow-sm",children:[e.jsx("img",{src:t,alt:`preview ${o}`,className:"w-full h-full object-cover cursor-pointer hover:opacity-90 transition",onClick:()=>k(o)}),e.jsxs("div",{className:"absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition flex flex-col justify-between p-1",children:[e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{type:"button",onClick:s=>{s.stopPropagation(),P(o)},className:"p-1 bg-red-500 text-white rounded-full hover:bg-red-600 transition",title:"删除",children:e.jsx($,{size:12})})}),e.jsxs("div",{className:"flex justify-between items-end",children:[e.jsx("button",{type:"button",disabled:o===0,onClick:s=>{s.stopPropagation(),I(o,"left")},className:`p-1 bg-black/50 text-white rounded hover:bg-indigo-500 transition ${o===0?"opacity-0":""}`,title:"左移",children:e.jsx(M,{size:12})}),e.jsx("button",{type:"button",disabled:o===i.length-1,onClick:s=>{s.stopPropagation(),I(o,"right")},className:`p-1 bg-black/50 text-white rounded hover:bg-indigo-500 transition ${o===i.length-1?"opacity-0":""}`,title:"右移",children:e.jsx(L,{size:12})})]})]}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-black/50 text-white text-[10px] px-1 py-0.5 truncate pointer-events-none",children:(a=i[o])==null?void 0:a.name})]},t)}),i.length+((c==null?void 0:c.length)||0)<w&&e.jsxs("div",{className:"relative w-28 h-28 border-2 border-dashed border-gray-300 rounded-lg flex flex-col items-center justify-center text-gray-400 hover:border-indigo-500 hover:text-indigo-500 hover:bg-indigo-50 transition cursor-pointer group",children:[e.jsx("input",{type:"file",multiple:!0,accept:"image/png,image/jpeg,image/webp",className:"absolute inset-0 opacity-0 cursor-pointer",onChange:z}),e.jsx(E,{size:24,className:"group-hover:scale-110 transition"}),e.jsx("span",{className:"text-xs mt-2 font-medium",children:"上传图片"}),e.jsxs("span",{className:"text-[10px] text-gray-300 mt-0.5",children:[i.length+((c==null?void 0:c.length)||0),"/",w]})]})]}),e.jsx(D,{children:r!==null&&f!==null&&e.jsxs(A.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-[100] flex items-center justify-center bg-black/95 backdrop-blur-sm",onClick:C,children:[e.jsxs("div",{className:"absolute top-0 left-0 w-full p-4 flex justify-between items-center z-10",onClick:t=>t.stopPropagation(),children:[e.jsx("div",{className:"text-white/80 text-sm font-mono",children:f==="new"?e.jsxs(e.Fragment,{children:[(n=i[r])==null?void 0:n.name," (",Math.round((((_=i[r])==null?void 0:_.size)||0)/1024)," KB)",e.jsxs("span",{className:"ml-2 px-2 py-0.5 bg-white/10 rounded-full",children:[r+1," / ",i.length]})]}):e.jsxs(e.Fragment,{children:["已上传图片",e.jsxs("span",{className:"ml-2 px-2 py-0.5 bg-white/10 rounded-full",children:[r+1," / ",c.length]})]})}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-1 bg-white/10 px-2 py-1 rounded-full backdrop-blur-md",children:[e.jsx("button",{onClick:()=>m(t=>Math.max(.2,t-.2)),className:"text-white/80 hover:text-white p-2 rounded-full hover:bg-white/10 transition",title:"缩小",children:e.jsx(le,{size:20})}),e.jsxs("span",{className:"text-xs text-white min-w-[3em] text-center font-mono",children:[Math.round(y*100),"%"]}),e.jsx("button",{onClick:()=>m(t=>Math.min(5,t+.2)),className:"text-white/80 hover:text-white p-2 rounded-full hover:bg-white/10 transition",title:"放大",children:e.jsx(re,{size:20})}),e.jsx("div",{className:"w-px h-4 bg-white/20 mx-1"}),e.jsx("button",{onClick:()=>x(t=>t-90),className:"text-white/80 hover:text-white p-2 rounded-full hover:bg-white/10 transition",title:"向左旋转",children:e.jsx(T,{className:"-scale-x-100",size:20})}),e.jsx("button",{onClick:()=>x(t=>t+90),className:"text-white/80 hover:text-white p-2 rounded-full hover:bg-white/10 transition",title:"向右旋转",children:e.jsx(T,{size:20})})]}),e.jsx("button",{onClick:C,className:"text-white/80 hover:text-white hover:bg-red-500/80 p-2 rounded-full transition",children:e.jsx($,{size:28})})]})]}),e.jsxs("div",{className:"w-full h-full flex items-center justify-center overflow-hidden relative",onClick:t=>t.stopPropagation(),children:[r>0&&e.jsx("div",{className:"absolute left-0 top-0 bottom-0 w-24 flex items-center justify-center hover:bg-white/5 cursor-pointer transition group z-10",onClick:t=>{t.stopPropagation(),d(r-1),x(0),m(1)},children:e.jsx(M,{size:40,className:"text-white/30 group-hover:text-white transition"})}),f==="new"&&r<i.length-1&&e.jsx("div",{className:"absolute right-0 top-0 bottom-0 w-24 flex items-center justify-center hover:bg-white/5 cursor-pointer transition group z-10",onClick:t=>{t.stopPropagation(),d(r+1),x(0),m(1)},children:e.jsx(L,{size:40,className:"text-white/30 group-hover:text-white transition"})}),f==="initial"&&r<c.length-1&&e.jsx("div",{className:"absolute right-0 top-0 bottom-0 w-24 flex items-center justify-center hover:bg-white/5 cursor-pointer transition group z-10",onClick:t=>{t.stopPropagation(),d(r+1),x(0),m(1)},children:e.jsx(L,{size:40,className:"text-white/30 group-hover:text-white transition"})}),e.jsx(A.div,{className:"relative cursor-grab active:cursor-grabbing",animate:{rotate:v,scale:y},transition:{type:"spring",stiffness:200,damping:20},drag:!0,dragConstraints:{left:-500,right:500,top:-500,bottom:500},children:e.jsx("img",{src:f==="initial"?c[r]:j[r],alt:"preview",className:"max-w-[90vw] max-h-[85vh] object-contain shadow-2xl rounded-lg",draggable:!1})})]})]})})]})}function Se(){const[i,b]=l.useState(""),[w,c]=l.useState([]),[g,j]=l.useState(""),[p,r]=l.useState(""),[d,f]=l.useState([]),[N,y]=l.useState([]),[m,v]=l.useState(""),[x,z]=l.useState(!1),[P,I]=l.useState(0),S=O(),{show:k}=B(),[C]=F(),n=C.get("edit"),_=()=>!i||i.length>50?"标题需填写且不超过50字":!p||p.length>2e3?"内容需填写且不超过2000字":g?"":"请选择课程",t=async()=>{const a=_();if(a){v(a);return}z(!0);try{let s=[];if(d.length&&(s=((await G.uploadImageBatch(d,u=>I(u))).urls||[]).map(u=>u.url)),n){await q.update(n,{courseId:g,title:i,contentHTML:p,images:[...N,...s]});try{localStorage.removeItem(`qa_edit_${n}`),localStorage.removeItem(`qa_edit_draft_${n}`),localStorage.setItem(`qa_edit_success_${n}`,"1")}catch{}v("更新成功"),k("更新成功","success"),setTimeout(()=>{try{S(`/student/qa/${n}`,{replace:!0})}catch{}},400)}else{const h=await q.create({courseId:g,title:i,contentHTML:p,images:s});localStorage.removeItem("qa_publish_draft"),v("发布成功"),k("发布成功","success"),setTimeout(()=>{try{S("/student/qa",{replace:!0})}catch{}},500)}}catch{v("发布失败，请重试"),k("发布失败，请重试","error")}finally{z(!1)}};l.useEffect(()=>{J.list().then(a=>{const s=(a.items||[]).map(h=>h.name);s.length&&(c(s),j(s[0]))}).catch(()=>{})},[]),l.useEffect(()=>{if(n)try{const a=localStorage.getItem(`qa_edit_${n}`);if(a){const s=JSON.parse(a||"{}");if(s.title&&b(s.title),s.content&&r(s.content),Array.isArray(s.images)){const h=s.images.map(u=>/^https?:\/\//.test(u)?u:`${Q}${u}`);y(h)}s.courseId&&j(s.courseId)}}catch{}},[n]);const o={hidden:{opacity:0,y:20},visible:{opacity:1,y:0,transition:{duration:.4,ease:"easeOut"}}};return e.jsxs(A.div,{initial:"hidden",animate:"visible",variants:o,className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 min-h-screen",children:[e.jsx("div",{className:"flex flex-col md:flex-row md:items-end justify-between gap-6 mb-8",children:e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm text-slate-500 font-medium mb-2",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(W,{size:14})," 问答社区"]}),e.jsx(V,{size:14,className:"opacity-50"}),e.jsx("span",{className:"text-indigo-600",children:n?"编辑问题":"发布问题"})]}),e.jsxs("h1",{className:"text-3xl font-extrabold text-slate-900 tracking-tight flex items-center gap-3",children:[n?"编辑":"提问",e.jsx("span",{className:"p-2 bg-indigo-50 rounded-xl text-indigo-600",children:e.jsx(X,{size:24,strokeWidth:2.5})})]}),e.jsx("p",{className:"mt-2 text-slate-500 max-w-xl",children:"准确描述你的问题，更容易获得同学和老师的解答。"})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-8 items-start",children:[e.jsx("div",{className:"lg:col-span-2 space-y-6",children:e.jsxs("div",{className:"bg-white rounded-2xl shadow-sm border border-slate-100 p-6 sm:p-8",children:[e.jsxs("div",{className:"mb-6 relative group",children:[e.jsx("div",{className:"absolute top-3.5 left-0 pl-4 text-slate-400 group-focus-within:text-indigo-500 transition-colors pointer-events-none",children:e.jsx(Y,{size:20})}),e.jsx("input",{className:"w-full pl-12 pr-16 py-3 bg-slate-50 border border-transparent focus:bg-white focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 rounded-xl text-lg font-bold text-slate-800 placeholder:text-slate-400 transition-all outline-none",placeholder:"一句话描述你的问题（50字以内）",value:i,onChange:a=>b(a.target.value),maxLength:50}),e.jsxs("span",{className:"absolute right-4 top-4 text-xs font-mono text-slate-400",children:[i.length,"/50"]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute top-3.5 left-4 text-slate-400 pointer-events-none",children:e.jsx(H,{size:20})}),e.jsx("select",{className:"w-full pl-12 pr-10 py-3 bg-slate-50 border border-transparent focus:bg-white focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 rounded-xl text-sm font-medium text-slate-700 appearance-none cursor-pointer transition-all outline-none",value:g,onChange:a=>j(a.target.value),children:w.map(a=>e.jsx("option",{value:a,children:a},a))}),e.jsx("div",{className:"absolute top-3.5 right-4 text-slate-400 pointer-events-none",children:e.jsx(U,{size:16})})]}),e.jsx("p",{className:"mt-1.5 text-xs text-slate-400 ml-1",children:"选择关联的课程，该问题将显示在课程讨论区"})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("div",{className:"border border-slate-200 rounded-xl overflow-hidden focus-within:ring-4 focus-within:ring-indigo-500/10 focus-within:border-indigo-500 transition-all",children:e.jsx(Z,{value:p,onChange:r,maxLength:2e3,storageKey:n?`qa_edit_draft_${n}`:"qa_publish_draft"})}),e.jsx("div",{className:"flex justify-end mt-1.5",children:e.jsxs("span",{className:`text-xs font-mono ${p.length>1800?"text-amber-500":"text-slate-400"}`,children:[p.length,"/2000"]})})]}),e.jsxs("div",{className:"mb-8",children:[e.jsxs("label",{className:"block text-sm font-bold text-slate-700 mb-3 flex items-center gap-2",children:[e.jsx(E,{size:16,className:"text-indigo-500"}),"补充图片 ",e.jsx("span",{className:"text-xs font-normal text-slate-400",children:"(可选，最多9张)"})]}),e.jsx("div",{className:"p-4 bg-slate-50/50 border border-dashed border-slate-200 rounded-xl hover:bg-slate-50 transition-colors",children:e.jsx(ce,{images:d,onChange:f,maxCount:9,initialUrls:N,onInitialUrlsChange:y})})]}),e.jsxs("div",{className:"flex items-center justify-between pt-6 border-t border-slate-100",children:[e.jsx("div",{className:"flex items-center gap-2 min-h-[24px]",children:m&&e.jsxs("span",{className:`text-sm flex items-center gap-1.5 animate-in fade-in slide-in-from-left-2 ${m.includes("成功")?"text-emerald-600":"text-rose-500"}`,children:[e.jsx(ee,{size:16})," ",m]})}),e.jsxs("button",{onClick:t,disabled:x,className:"flex items-center gap-2 px-8 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg shadow-indigo-200 hover:bg-indigo-700 hover:shadow-indigo-300 active:scale-95 disabled:opacity-70 disabled:cursor-not-allowed transition-all",children:[x?e.jsx(K,{size:18,className:"animate-spin"}):e.jsx(te,{size:18}),x?n?"保存中...":"发布中...":n?"保存修改":"立即发布"]}),x&&d.length>0&&e.jsxs("span",{className:"ml-3 text-xs text-slate-400",children:["上传进度 ",P,"%"]})]})]})}),e.jsx("div",{className:"lg:col-span-1 space-y-6",children:e.jsxs("div",{className:"bg-gradient-to-b from-indigo-50 to-white rounded-2xl p-6 border border-indigo-100 shadow-sm sticky top-6",children:[e.jsxs("h3",{className:"font-bold text-slate-800 flex items-center gap-2 mb-4",children:[e.jsx(se,{size:18,className:"text-indigo-500"})," 提问小贴士"]}),e.jsx("ul",{className:"space-y-4",children:[{title:"标题要具体",desc:"避免使用“求助”、“报错”等模糊标题，尽量概括核心问题。"},{title:"提供上下文",desc:"描述你已经尝试过的方法，贴出相关代码或报错截图。"},{title:"选择正确课程",desc:"关联正确的课程可以让相关老师和助教更快看到你的问题。"},{title:"保持礼貌",desc:"友好的交流氛围有助于更快获得高质量的解答。"}].map((a,s)=>e.jsxs("li",{className:"flex gap-3 items-start",children:[e.jsx("div",{className:"mt-1 w-5 h-5 bg-white rounded-full flex items-center justify-center text-xs font-bold text-indigo-600 shadow-sm border border-indigo-100 shrink-0",children:s+1}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-slate-700",children:a.title}),e.jsx("p",{className:"text-xs text-slate-500 leading-relaxed mt-0.5",children:a.desc})]})]},s))}),e.jsx("div",{className:"mt-6 pt-4 border-t border-indigo-100/50",children:e.jsxs("div",{className:"flex items-start gap-2 p-3 bg-amber-50 rounded-xl text-amber-700 text-xs border border-amber-100",children:[e.jsx(ae,{size:16,className:"shrink-0 mt-0.5"}),e.jsx("span",{children:"发布即代表您同意社区规范，请勿发布与学习无关或违规的内容。"})]})})]})})]})]})}export{Se as default};
