import{l as K,u as V,d as Y,r as i,e as H,j as e,C as Z,U as L,m as d,Q as g,n as v}from"./index-742c88f7.js";import{R as ee}from"./RichText-8c20a8cd.js";import{A as se}from"./arrow-left-83ee801f.js";import{S as te}from"./share-2-d2cc455f.js";import{C as ae}from"./clock-a684511e.js";import{M as N,C as le}from"./message-circle-38b95ebc.js";import{I as ie}from"./image-703b1c2d.js";import{F as re}from"./file-text-ca3a3a77.js";import{E as ne}from"./eye-6021bed5.js";import{A as w}from"./index-7dbfdcd6.js";import{S as oe}from"./send-d827c15e.js";import{S as ce}from"./shield-alert-13d01dae.js";import{X as de}from"./x-551ee725.js";import{C as xe}from"./circle-check-135a219a.js";const me=({name:a,role:r})=>{var t;const o=r==="TEACHER"||r==="ADMIN";return e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center text-sm font-bold shadow-sm ${o?"bg-indigo-100 text-indigo-600":"bg-slate-100 text-slate-500"}`,children:((t=a==null?void 0:a[0])==null?void 0:t.toUpperCase())||"U"})},M=({status:a})=>{const r=a==="open";return e.jsxs("span",{className:`inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider border ${r?"bg-amber-50 text-amber-600 border-amber-200":"bg-emerald-50 text-emerald-600 border-emerald-200"}`,children:[r?e.jsx(le,{size:14}):e.jsx(xe,{size:14}),r?"待解决":"已解决"]})};function Ae(){const{questionId:a}=K(),r=V(),{show:o}=Y(),[t,f]=i.useState(null),[x,y]=i.useState([]),[m,C]=i.useState(""),[p,u]=i.useState(!1),[B,k]=i.useState(!0),[_,S]=i.useState(!1),[O,b]=i.useState(!1),[A,E]=i.useState(""),[z,I]=i.useState(""),[T,R]=i.useState(!1),[h,j]=i.useState(null),D=typeof window<"u"?localStorage.getItem("role"):null;i.useEffect(()=>{(async()=>{if(a)try{k(!0);const[l,n]=await Promise.all([g.detail(a),v.listByQuestion(a)]);f(l),E(l.title||""),I(l.content||""),y(n.items||[])}catch(l){console.error(l)}finally{k(!1)}})()},[a]),i.useEffect(()=>{if(a)try{const s=`qa_edit_success_${a}`;typeof window<"u"&&localStorage.getItem(s)&&(localStorage.removeItem(s),o("更新成功","success"))}catch{}},[a]);const $=typeof window<"u"?localStorage.getItem("id"):null,P=$&&(t==null?void 0:t.createdById)&&String($)===String(t.createdById),Q=t!=null&&t.askerAvatar?/^https?:\/\//.test(t.askerAvatar)?t.askerAvatar:`${H}${t.askerAvatar.startsWith("/")?t.askerAvatar:"/"+t.askerAvatar}`:"",F=async s=>{if(a){S(!0);try{const l=await g.update(a,{status:s});f(l)}catch(l){alert((l==null?void 0:l.message)||"状态更新失败")}finally{S(!1)}}},U=()=>{if(t){try{const s={id:t.id,title:t.title||"",content:t.contentHTML||t.content||"",images:Array.isArray(t.images)?t.images:[],courseId:t.courseId||""};localStorage.setItem(`qa_edit_${t.id}`,JSON.stringify(s))}catch{}r(`/student/qa/publish?edit=${t.id}`)}},q=async()=>{if(a){u(!0);try{const s=await g.update(a,{title:A,content:z});f(s),b(!1)}catch(s){alert((s==null?void 0:s.message)||"更新失败")}finally{u(!1)}}},W=async()=>{if(a&&confirm("确定要删除该问题吗？此操作不可恢复")){R(!0);try{await g.remove(a),r("/student/qa")}catch(s){alert((s==null?void 0:s.message)||"删除失败")}finally{R(!1)}}},G=async()=>{if(!(!a||!m.trim())){u(!0);try{await v.createForQuestion(a,{content:m}),C("");const s=await v.listByQuestion(a);y(s.items||[])}catch{alert("发布失败，请重试")}finally{u(!1)}}},J=async()=>{try{const s=`${window.location.origin}/student/qa/${a}`,l=(t==null?void 0:t.title)||"问题详情",n=navigator;if(n&&typeof n.share=="function")await n.share({title:l,url:s}),o("分享成功","success");else if(navigator.clipboard&&typeof navigator.clipboard.writeText=="function")await navigator.clipboard.writeText(s),o("链接已复制","success");else{const c=document.createElement("textarea");c.value=s,document.body.appendChild(c),c.select(),document.execCommand("copy"),document.body.removeChild(c),o("链接已复制","success")}}catch{o("分享失败，请重试","error")}};return B||!t?e.jsxs("div",{className:"max-w-6xl mx-auto px-4 py-8 animate-pulse",children:[e.jsx("div",{className:"h-8 w-1/3 bg-slate-200 rounded mb-6"}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-12 gap-8",children:[e.jsxs("div",{className:"lg:col-span-8 space-y-6",children:[e.jsx("div",{className:"h-64 bg-slate-100 rounded-3xl"}),e.jsx("div",{className:"h-32 bg-slate-100 rounded-3xl"})]}),e.jsx("div",{className:"lg:col-span-4 h-64 bg-slate-100 rounded-3xl"})]})]}):e.jsxs("div",{className:"max-w-6xl mx-auto px-4 sm:px-6 py-8 min-h-screen",children:[e.jsxs("div",{className:"flex flex-col gap-4 mb-8",children:[e.jsxs("div",{className:"flex items-center gap-3 text-sm text-slate-500 font-medium",children:[e.jsx("button",{onClick:()=>r(-1),className:"p-1.5 rounded-lg hover:bg-slate-100 hover:text-slate-700 transition-colors",children:e.jsx(se,{size:16})}),e.jsx("div",{className:"w-px h-3 bg-slate-300"}),e.jsx("span",{className:"cursor-pointer hover:text-indigo-600",onClick:()=>r("/student/qa"),children:"问答社区"}),e.jsx(Z,{size:14,className:"opacity-50"}),e.jsx("span",{className:"text-indigo-600",children:"问题详情"})]}),e.jsxs("div",{className:"flex flex-col md:flex-row md:items-start justify-between gap-4",children:[e.jsx("h1",{className:"text-2xl md:text-3xl font-extrabold text-slate-900 leading-tight",children:t.title}),e.jsxs("div",{className:"flex items-center gap-3 shrink-0",children:[e.jsx("button",{onClick:J,className:"p-2 text-slate-400 hover:bg-slate-100 rounded-full transition-colors",children:e.jsx(te,{size:20})}),P&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:U,className:"flex items-center gap-2 px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-semibold shadow-md hover:shadow-lg active:scale-95 transition",children:"编辑"}),e.jsx("button",{onClick:W,disabled:T,className:"px-3 py-1.5 rounded-lg bg-rose-600 hover:bg-rose-700 text-white text-xs font-semibold transition disabled:opacity-50",children:T?"删除中...":"删除"})]})]})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-4 text-xs text-slate-500 pb-6 border-b border-slate-200",children:[e.jsx(M,{status:t.status}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[Q?e.jsx("img",{src:Q,alt:"头像",className:"w-5 h-5 rounded-full object-cover"}):e.jsx(L,{size:14}),t.askerName||"匿名同学"]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx(ae,{size:14})," ",new Date(t.createTime||Date.now()).toLocaleString()]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx(N,{size:14})," ",x.length," 回答"]})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-12 gap-8 items-start",children:[e.jsxs("div",{className:"lg:col-span-8 space-y-8",children:[e.jsxs("div",{className:"bg-white rounded-[2rem] p-6 md:p-8 shadow-sm border border-slate-100",children:[e.jsx("div",{className:"prose prose-slate max-w-none prose-p:text-slate-600 prose-headings:text-slate-800 prose-a:text-indigo-600",children:e.jsx(ee,{value:t.contentHTML||t.content,readOnly:!0})}),t.images&&t.images.length>0&&e.jsxs("div",{className:"mt-8 pt-6 border-t border-slate-50",children:[e.jsxs("h4",{className:"text-sm font-bold text-slate-700 mb-3 flex items-center gap-2",children:[e.jsx(ie,{size:16,className:"text-indigo-500"})," 附件预览"]}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:t.images.map((s,l)=>{const n=/^https?:\/\//.test(s)?s:`${H}${s}`,c=s.toLowerCase().endsWith(".pdf"),X=c?"pdf":"image";return e.jsxs(d.div,{whileHover:{y:-4},onClick:()=>j({url:n,type:X}),className:"group relative aspect-square rounded-2xl overflow-hidden bg-slate-50 border border-slate-200 cursor-pointer shadow-sm hover:shadow-md transition-all",children:[c?e.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-slate-400 group-hover:text-rose-500 transition-colors",children:[e.jsx(re,{size:32}),e.jsx("span",{className:"text-[10px] font-bold mt-2 uppercase tracking-wide",children:"PDF Document"})]}):e.jsx("img",{src:n,alt:`attachment-${l}`,className:"w-full h-full object-cover transition-transform duration-500 group-hover:scale-110"}),e.jsx("div",{className:"absolute inset-0 bg-black/0 group-hover:bg-black/10 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-all",children:e.jsx("div",{className:"bg-white/90 p-2 rounded-full shadow-lg",children:e.jsx(ne,{size:16,className:"text-slate-700"})})})]},l)})})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between px-2",children:e.jsxs("h3",{className:"font-bold text-slate-800 text-lg flex items-center gap-2",children:[e.jsx(N,{className:"text-indigo-500",size:20}),x.length," 个回答"]})}),e.jsx(w,{children:x.length>0?x.map((s,l)=>e.jsxs(d.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:l*.1},className:`bg-white p-6 rounded-2xl border shadow-sm relative overflow-hidden ${s.responderRole==="TEACHER"?"border-indigo-200 ring-1 ring-indigo-50":"border-slate-100"}`,children:[s.responderRole==="TEACHER"&&e.jsx("div",{className:"absolute top-0 left-0 w-1 h-full bg-indigo-500"}),e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx(me,{name:s.responderName,role:s.responderRole}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-bold text-slate-800 text-sm mr-2",children:s.responderName||"未知用户"}),s.responderRole==="TEACHER"&&e.jsx("span",{className:"px-1.5 py-0.5 bg-indigo-100 text-indigo-700 text-[10px] font-bold rounded uppercase",children:"Teacher"})]}),e.jsx("span",{className:"text-xs text-slate-400",children:new Date(s.createTime||Date.now()).toLocaleDateString()})]}),e.jsx("div",{className:"text-slate-600 text-sm leading-relaxed whitespace-pre-wrap",children:s.content})]})]})]},s.id)):e.jsxs("div",{className:"py-12 text-center bg-slate-50/50 rounded-2xl border border-dashed border-slate-200",children:[e.jsx("div",{className:"inline-flex p-3 bg-white rounded-full shadow-sm mb-3 text-slate-300",children:e.jsx(N,{size:24})}),e.jsx("p",{className:"text-slate-500 text-sm",children:"暂无回答，快来抢沙发吧！"})]})})]}),(D==="TEACHER"||D==="ADMIN")&&e.jsxs(d.div,{initial:{opacity:0},animate:{opacity:1},className:"bg-white rounded-2xl p-6 shadow-lg shadow-indigo-100/50 border border-slate-100 sticky bottom-6 z-20",children:[e.jsxs("h4",{className:"font-bold text-slate-800 mb-3 flex items-center gap-2",children:[e.jsx(L,{size:18,className:"text-indigo-500"})," 撰写回答"]}),e.jsxs("div",{className:"relative group",children:[e.jsx("textarea",{value:m,onChange:s=>C(s.target.value),rows:4,className:"w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:bg-white focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all resize-none text-slate-700",placeholder:"请输入您的专业解答..."}),e.jsx("button",{onClick:G,disabled:p||!m.trim(),className:"absolute bottom-3 right-3 flex items-center gap-2 px-4 py-2 bg-indigo-600 hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed text-white rounded-lg text-sm font-bold transition-all shadow-md",children:p?"发布中...":e.jsxs(e.Fragment,{children:[e.jsx(oe,{size:14})," 发布"]})})]})]})]}),e.jsx("div",{className:"lg:col-span-4 space-y-6",children:e.jsxs("div",{className:"bg-white rounded-[2rem] p-6 shadow-sm border border-slate-100",children:[e.jsx("h4",{className:"font-bold text-slate-800 mb-4 text-sm uppercase tracking-wider",children:"Information"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex justify-between items-center p-3 bg-slate-50 rounded-xl",children:[e.jsx("span",{className:"text-xs text-slate-500",children:"问题 ID"}),e.jsxs("span",{className:"text-sm font-mono font-bold text-slate-700",children:["#",a==null?void 0:a.slice(0,8)]})]}),e.jsxs("div",{className:"p-3 bg-slate-50 rounded-xl",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-xs text-slate-500",children:"当前状态"}),e.jsx(M,{status:t.status})]}),P&&e.jsxs("div",{className:"flex items-center gap-4 text-sm",children:[e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"qstatus",checked:t.status==="open",onChange:()=>F("open")})," 待解决"]}),e.jsxs("label",{className:"inline-flex items-center gap-2",children:[e.jsx("input",{type:"radio",name:"qstatus",checked:t.status==="solved",onChange:()=>F("solved")})," 已解决"]}),_&&e.jsx("span",{className:"text-xs text-slate-400",children:"更新中..."})]})]}),e.jsxs("div",{className:"mt-4 p-4 bg-amber-50 border border-amber-100 rounded-xl flex gap-3",children:[e.jsx(ce,{className:"text-amber-500 shrink-0",size:20}),e.jsxs("div",{className:"text-xs text-amber-800 leading-relaxed",children:[e.jsx("span",{className:"font-bold block mb-1",children:"回答规范"}),"请友善交流，避免发布无关内容。高质量的回答将获得社区积分奖励。"]})]})]})]})})]}),e.jsx(w,{children:h&&e.jsx(d.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm p-4 md:p-8",onClick:()=>j(null),children:e.jsxs(d.div,{initial:{scale:.95,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.95,opacity:0},className:"relative w-full h-full max-w-5xl max-h-[90vh] bg-transparent flex flex-col items-center justify-center",onClick:s=>s.stopPropagation(),children:[e.jsx("button",{onClick:()=>j(null),className:"absolute -top-12 right-0 p-2 text-white/70 hover:text-white hover:bg-white/10 rounded-full transition-colors",children:e.jsx(de,{size:24})}),e.jsx("div",{className:"w-full h-full flex items-center justify-center overflow-hidden rounded-xl shadow-2xl",children:h.type==="image"?e.jsx("img",{src:h.url,alt:"Full Preview",className:"max-w-full max-h-full object-contain bg-black"}):e.jsx("iframe",{src:h.url,title:"PDF Preview",className:"w-full h-full bg-white",frameBorder:"0"})})]})})}),e.jsx(w,{children:O&&e.jsx(d.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 bg-black/50 flex items-center justify-center p-4",onClick:()=>b(!1),children:e.jsxs(d.div,{initial:{scale:.98},animate:{scale:1},exit:{scale:.98},className:"bg-white rounded-2xl w-full max-w-lg p-6",onClick:s=>s.stopPropagation(),children:[e.jsx("h4",{className:"font-bold text-slate-800 mb-4",children:"编辑问题"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("input",{value:A,onChange:s=>E(s.target.value),className:"w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm",placeholder:"标题"}),e.jsx("textarea",{value:z,onChange:s=>I(s.target.value),rows:6,className:"w-full px-3 py-2 bg-slate-50 border border-slate-200 rounded-lg text-sm",placeholder:"内容"})]}),e.jsxs("div",{className:"mt-4 flex justify-end gap-2",children:[e.jsx("button",{onClick:()=>b(!1),className:"px-3 py-2 bg-white border border-slate-200 rounded-lg text-sm",children:"取消"}),e.jsx("button",{onClick:q,disabled:p,className:"px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg text-sm",children:p?"保存中...":"保存"})]})]})})})]})}export{Ae as default};
