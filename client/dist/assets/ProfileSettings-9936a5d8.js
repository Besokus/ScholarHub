import{u as de,b as me,r as l,A as c,j as e,m as w,S as xe,U as ue}from"./index-5b5873b3.js";import{U as he}from"./uploads-b96cf77c.js";import{C as ge}from"./chevron-left-cdf6b024.js";import{I as O}from"./image-2ccc8df4.js";import{C as pe}from"./cloud-upload-9d40b75f.js";import{C as A}from"./check-40a953ba.js";import{C as T}from"./circle-alert-b381806f.js";import{S as be}from"./shield-check-3c01b35e.js";import{M as fe}from"./mail-6167b5f6.js";import{L as X}from"./lock-126f5e55.js";function Ue(){const Y=de(),{show:i}=me(),Z=localStorage.getItem("id")||"",[J,L]=l.useState(""),[b,F]=l.useState("");l.useEffect(()=>{c.me().then(s=>{var t,a;L(((t=s==null?void 0:s.user)==null?void 0:t.email)||""),F(((a=s==null?void 0:s.user)==null?void 0:a.username)||"")}).catch(()=>{})},[]);const[je,y]=l.useState(null),[o,C]=l.useState(null),[f,V]=l.useState(0),[j,q]=l.useState(0),[v,_]=l.useState(1),H=s=>{var a;s.preventDefault();const t=(a=s.dataTransfer.files)==null?void 0:a[0];t&&$(t)},K=s=>{var a;const t=(a=s.target.files)==null?void 0:a[0];t&&$(t)},$=s=>{if(!["image/jpeg","image/png","image/gif"].includes(s.type)){i("仅支持JPG/PNG/GIF","error");return}if(s.size>5*1024*1024){i("图片大小不超过5MB","error");return}y(s),C(URL.createObjectURL(s))},Q=async()=>{if(!o)return;const s=document.createElement("img");s.src=o,await new Promise(p=>{s.onload=()=>p(null)});const t=Math.min(s.width,s.height),a=Math.floor(t/v),h=s.width-a,N=s.height-a,re=Math.max(0,Math.min(Math.floor(f*h),h)),ie=Math.max(0,Math.min(Math.floor(j*N),N)),g=document.createElement("canvas");g.width=a,g.height=a,g.getContext("2d").drawImage(s,re,ie,a,a,0,0,a,a);let E=.9,P=await new Promise(p=>g.toBlob(U=>p(U),"image/jpeg",E));P.size>1024*1024&&(E=.8,P=await new Promise(p=>g.toBlob(U=>p(U),"image/jpeg",E)));const oe=`${Z||"user"}-${Date.now()}.jpg`,ne=new File([P],oe,{type:"image/jpeg"}),ce=await he.uploadAvatar(ne);await c.updateAvatar(ce.url),i("头像已更新","success"),y(null),o&&URL.revokeObjectURL(o),C(null)},[m,I]=l.useState(""),[n,z]=l.useState(""),S=l.useRef(null);l.useEffect(()=>{I(b)},[b]);const W=s=>{I(s),S.current&&clearTimeout(S.current),S.current=setTimeout(async()=>{if(!/^[A-Za-z0-9_\-\.]{2,20}$/.test(s)){z("2-20字符，字母数字下划线");return}try{const a=await c.checkUsername(s);z(a.exists&&s!==b?"用户名已被占用":"")}catch{z("校验失败")}},300)},ee=async()=>{var s;if(!n)try{const t=await c.updateUsername(m.trim());F(((s=t==null?void 0:t.user)==null?void 0:s.username)||m),i("用户名已更新","success")}catch(t){i((t==null?void 0:t.message)||"更新失败","error")}},[r,R]=l.useState(""),[d,B]=l.useState(""),x=l.useMemo(()=>{const s=r.length,t=/[a-z]/.test(r),a=/[A-Z]/.test(r),h=/[0-9]/.test(r),N=/[^A-Za-z0-9]/.test(r);return s<8||/^[A-Za-z]+$/.test(r)?"low":s<=12&&t&&(a||h)?"medium":s>12&&t&&a&&h&&N?"strong":"medium"},[r]),se=async()=>{if(x==="low"){i("密码强度不足","error");return}if(r!==d){i("两次输入不一致","error");return}try{await c.updatePassword("",r),i("密码已更新","success"),R(""),B("")}catch(s){i((s==null?void 0:s.message)||"更新失败","error")}},[u,D]=l.useState(""),[k,G]=l.useState(""),te=async()=>{if(u)try{const s=await c.emailCheck(u);G(s!=null&&s.valid?"":(s==null?void 0:s.reason)||"邮箱不可用")}catch{G("邮箱验证失败")}},ae=async()=>{if(k){i("请先修正邮箱","error");return}try{const s=await c.updateEmail(u.trim());i("邮箱已更新","success"),L((s==null?void 0:s.email)||u),D("")}catch(s){i((s==null?void 0:s.message)||"更新失败","error")}},le={hidden:{opacity:0,y:10},visible:{opacity:1,y:0,transition:{staggerChildren:.1}}},M={hidden:{opacity:0,y:10},visible:{opacity:1,y:0}};return e.jsxs(w.div,{initial:"hidden",animate:"visible",variants:le,className:"max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-10 min-h-screen",children:[e.jsxs("div",{className:"flex flex-col gap-2 mb-8",children:[e.jsxs("button",{onClick:()=>Y("/student/profile"),className:"self-start flex items-center gap-1 text-sm font-medium text-slate-500 hover:text-indigo-600 transition-colors group mb-2",children:[e.jsx(ge,{size:16,className:"group-hover:-translate-x-0.5 transition-transform"}),"返回个人中心"]}),e.jsxs("h1",{className:"text-3xl font-extrabold text-slate-900 tracking-tight flex items-center gap-3",children:[e.jsx(xe,{className:"text-indigo-600",size:32})," 账户设置"]}),e.jsx("p",{className:"text-slate-500",children:"管理您的头像、安全及联系方式"})]}),e.jsxs("div",{className:"space-y-8",children:[e.jsxs(w.section,{variants:M,className:"bg-white rounded-3xl shadow-sm border border-slate-100 p-8 hover:shadow-md transition-shadow",children:[e.jsx("div",{className:"flex items-center justify-between mb-6 pb-4 border-b border-slate-50",children:e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-bold text-slate-800 flex items-center gap-2",children:[e.jsx(O,{size:20,className:"text-indigo-500"})," 头像设置"]}),e.jsx("p",{className:"text-sm text-slate-400 mt-1",children:"支持 JPG/PNG/GIF 格式，文件大小不超过 5MB"})]})}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-12 gap-8",children:[e.jsx("div",{className:"lg:col-span-5",children:e.jsxs("div",{onDrop:H,onDragOver:s=>s.preventDefault(),className:"relative h-64 border-2 border-dashed border-slate-200 rounded-2xl bg-slate-50 hover:bg-indigo-50/30 hover:border-indigo-300 transition-all flex flex-col items-center justify-center text-center cursor-pointer group",children:[e.jsx("input",{type:"file",accept:"image/jpeg,image/png,image/gif",onChange:K,className:"absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10"}),e.jsx("div",{className:"p-4 bg-white rounded-full shadow-sm mb-3 group-hover:scale-110 transition-transform",children:e.jsx(pe,{size:32,className:"text-indigo-500"})}),e.jsx("p",{className:"text-sm font-medium text-slate-700",children:"点击或拖拽图片上传"}),e.jsx("p",{className:"text-xs text-slate-400 mt-1",children:"推荐尺寸 200x200 像素"})]})}),e.jsx("div",{className:"lg:col-span-7 space-y-6",children:o?e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 animate-fade-in",children:[e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-3 p-4 bg-slate-50 rounded-xl border border-slate-100",children:[e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs font-semibold text-slate-500 mb-1.5 flex justify-between",children:["水平位置 (X) ",e.jsxs("span",{children:[Math.floor(f*100),"%"]})]}),e.jsx("input",{type:"range",min:0,max:100,value:Math.floor(f*100),onChange:s=>V(Number(s.target.value)/100),className:"w-full accent-indigo-600 h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs font-semibold text-slate-500 mb-1.5 flex justify-between",children:["垂直位置 (Y) ",e.jsxs("span",{children:[Math.floor(j*100),"%"]})]}),e.jsx("input",{type:"range",min:0,max:100,value:Math.floor(j*100),onChange:s=>q(Number(s.target.value)/100),className:"w-full accent-indigo-600 h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"text-xs font-semibold text-slate-500 mb-1.5 flex justify-between",children:["缩放比例 ",e.jsxs("span",{children:[v.toFixed(2),"x"]})]}),e.jsx("input",{type:"range",min:1,max:3,step:.01,value:v,onChange:s=>_(Number(s.target.value)),className:"w-full accent-indigo-600 h-1.5 bg-slate-200 rounded-lg appearance-none cursor-pointer"})]})]}),e.jsxs("div",{className:"flex gap-3 pt-2",children:[e.jsxs("button",{onClick:Q,className:"flex-1 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-sm font-bold shadow-lg shadow-indigo-200 transition-all flex items-center justify-center gap-2",children:[e.jsx(A,{size:16})," 保存修改"]}),e.jsx("button",{onClick:()=>{o&&URL.revokeObjectURL(o),C(null),y(null)},className:"px-4 py-2.5 bg-white border border-slate-200 text-slate-600 hover:bg-slate-50 rounded-xl text-sm font-medium transition-colors",children:"取消"})]})]}),e.jsxs("div",{className:"bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden w-full max-w-[240px] mx-auto",children:[e.jsx("div",{className:"h-20 bg-gradient-to-r from-indigo-500 to-purple-600 relative"}),e.jsxs("div",{className:"px-5 pb-5 relative",children:[e.jsx("div",{className:"w-20 h-20 -mt-10 rounded-2xl border-4 border-white shadow-md overflow-hidden bg-white relative",children:e.jsx("img",{src:o,alt:"Preview",style:{width:"100%",height:"100%",objectFit:"cover",objectPosition:`${Math.floor(f*100)}% ${Math.floor(j*100)}%`,transform:`scale(${v})`}})}),e.jsxs("div",{className:"mt-3 space-y-1 text-center",children:[e.jsx("div",{className:"h-4 bg-slate-200 rounded w-2/3 mx-auto"}),e.jsx("div",{className:"h-3 bg-slate-100 rounded w-1/2 mx-auto"})]})]}),e.jsx("div",{className:"bg-slate-50 py-2 text-center text-[10px] text-slate-400 font-medium border-t border-slate-100",children:"主页效果预览"})]})]}):e.jsxs("div",{className:"h-full flex flex-col items-center justify-center text-slate-400 bg-slate-50/50 rounded-2xl border border-dashed border-slate-200 min-h-[200px]",children:[e.jsx(O,{size:48,className:"opacity-20 mb-2"}),e.jsx("span",{className:"text-sm",children:"上传图片后在此预览裁剪效果"})]})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-8",children:[e.jsxs(w.section,{variants:M,className:"bg-white rounded-3xl shadow-sm border border-slate-100 p-8 hover:shadow-md transition-shadow h-full",children:[e.jsxs("h3",{className:"text-lg font-bold text-slate-800 mb-6 flex items-center gap-2 pb-4 border-b border-slate-50",children:[e.jsx(ue,{size:20,className:"text-blue-500"})," 基本资料"]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-semibold text-slate-700 mb-2",children:"用户名"}),e.jsxs("div",{className:"relative",children:[e.jsx("input",{value:m,onChange:s=>W(s.target.value),className:`w-full pl-4 pr-10 py-3 bg-slate-50 border rounded-xl text-sm focus:bg-white focus:outline-none focus:ring-4 transition-all ${n?"border-rose-300 focus:ring-rose-500/10":"border-slate-200 focus:border-indigo-500 focus:ring-indigo-500/10"}`,placeholder:"请输入新用户名"}),e.jsx("div",{className:"absolute right-3 top-3 text-slate-400 pointer-events-none",children:n?e.jsx(T,{size:18,className:"text-rose-500"}):e.jsx(A,{size:18,className:m&&!n?"text-emerald-500":"opacity-0"})})]}),n&&e.jsxs("p",{className:"mt-1.5 text-xs text-rose-500 font-medium flex items-center gap-1",children:[e.jsx(T,{size:12})," ",n]}),e.jsx("p",{className:"mt-2 text-xs text-slate-400",children:"用户名必须唯一，支持字母、数字和下划线。"})]}),e.jsx("div",{className:"pt-2",children:e.jsx("button",{onClick:ee,disabled:!!n||m===b,className:"w-full py-3 bg-slate-900 hover:bg-slate-800 disabled:bg-slate-100 disabled:text-slate-400 text-white rounded-xl text-sm font-bold transition-all",children:"更新用户名"})})]})]}),e.jsxs(w.section,{variants:M,className:"bg-white rounded-3xl shadow-sm border border-slate-100 p-8 hover:shadow-md transition-shadow h-full",children:[e.jsxs("h3",{className:"text-lg font-bold text-slate-800 mb-6 flex items-center gap-2 pb-4 border-b border-slate-50",children:[e.jsx(be,{size:20,className:"text-emerald-500"})," 安全设置"]}),e.jsxs("div",{className:"mb-8",children:[e.jsx("label",{className:"block text-sm font-semibold text-slate-700 mb-2",children:"绑定邮箱"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs("div",{className:"relative flex-1",children:[e.jsx(fe,{size:16,className:"absolute left-3.5 top-3.5 text-slate-400"}),e.jsx("input",{value:u,onChange:s=>D(s.target.value),onBlur:te,placeholder:J||"未绑定邮箱",className:"w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:bg-white focus:border-emerald-500 focus:ring-4 focus:ring-emerald-500/10 outline-none transition-all"})]}),e.jsx("button",{onClick:ae,className:"px-4 py-2 bg-white border border-slate-200 hover:border-emerald-500 hover:text-emerald-600 text-slate-600 rounded-xl text-sm font-semibold transition-colors",children:"修改"})]}),k&&e.jsx("p",{className:"mt-1.5 text-xs text-rose-500 font-medium",children:k})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"flex justify-between items-center mb-2",children:[e.jsx("label",{className:"text-sm font-semibold text-slate-700",children:"修改密码"}),r&&e.jsxs("span",{className:`text-xs font-bold px-2 py-0.5 rounded ${x==="strong"?"bg-emerald-100 text-emerald-700":x==="medium"?"bg-orange-100 text-orange-700":"bg-rose-100 text-rose-700"}`,children:["强度: ",x==="strong"?"强":x==="medium"?"中":"弱"]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(X,{size:16,className:"absolute left-3.5 top-3.5 text-slate-400"}),e.jsx("input",{type:"password",value:r,onChange:s=>R(s.target.value),placeholder:"新密码 (至少8位)",className:"w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:bg-white focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all"})]}),e.jsxs("div",{className:"relative",children:[e.jsx(X,{size:16,className:"absolute left-3.5 top-3.5 text-slate-400"}),e.jsx("input",{type:"password",value:d,onChange:s=>B(s.target.value),placeholder:"确认新密码",className:"w-full pl-10 pr-10 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:bg-white focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/10 outline-none transition-all"}),d&&d===r&&e.jsx(A,{size:16,className:"absolute right-3.5 top-3.5 text-emerald-500"})]}),e.jsx("button",{onClick:se,disabled:!r||!d||r!==d,className:"w-full mt-2 py-3 bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-200 disabled:text-slate-400 text-white rounded-xl text-sm font-bold shadow-lg shadow-indigo-200 disabled:shadow-none transition-all",children:"重置密码"})]})]})]})]})]})]})}export{Ue as default};
