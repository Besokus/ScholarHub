version: '3.9'

services:
  postgres:
    image: postgres:14-alpine
    container_name: scholarhub-postgres
    env_file:
      - ./server/.env
    environment:
      - POSTGRES_USER=${PGUSER}
      - POSTGRES_PASSWORD=${PGPASSWORD}
      - POSTGRES_DB=${PGDATABASE}
    volumes:
      - pg_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${PGUSER} -d ${PGDATABASE} || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - scholarhub

  redis:
    image: redis:7-alpine
    container_name: scholarhub-redis
    command: ["redis-server", "--appendonly", "yes"]
    # 如需密码，可改为：
    # command: ["redis-server", "--appendonly", "yes", "--requirepass", "${PGPASSWORD}"]
    volumes:
      - redis_data:/data
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped
    networks:
      - scholarhub

  server:
    build: ./server
    container_name: scholarhub-server
    env_file:
      - ./server/.env
    environment:
      # 如 server/.env 中未设置 PORT，则默认 3001
      - PORT=${PORT:-3001}
      # 覆盖为容器网络内使用的数据库地址
      - DATABASE_URL=postgresql://${PGUSER}:${PGPASSWORD}@postgres:5432/${PGDATABASE}?search_path=public
      # 覆盖为容器网络内使用的 Redis 地址（无密码版本）
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=${JWT_SECRET}
      - ADMIN_PASSWORD=${ADMIN_PASSWORD}
      - ADMIN_EMAIL=${ADMIN_EMAIL}
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    ports:
      - "3001:3001"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:${PORT:-3001}/api/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
    restart: unless-stopped
    networks:
      - scholarhub
    volumes:
      # 日志与上传目录持久化（路径需与 Dockerfile 中工作目录对应）
      - server_logs:/app/logs
      - server_uploads:/app/uploads

  admin:
    build: ./backend-go
    container_name: scholarhub-admin
    env_file:
      - ./server/.env
    environment:
      - DATABASE_URL=postgresql://${PGUSER}:${PGPASSWORD}@postgres:5432/${PGDATABASE}?search_path=public
      - JWT_SECRET=${JWT_SECRET}
      # 管理端监听端口
      - ADMIN_PORT=4000
      # 允许的前端来源（可根据实际前端地址调整）
      - ALLOWED_ORIGINS=http://localhost:3000
    depends_on:
      postgres:
        condition: service_healthy
    ports:
      - "4000:4000"
    healthcheck:
      # Go 管理端的健康检查接口（来自 admin.go 下的 /api/admin/health）
      test: ["CMD-SHELL", "curl -f http://localhost:4000/api/admin/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 6
    restart: unless-stopped
    networks:
      - scholarhub
    volumes:
      - admin_logs:/var/log/scholarhub-admin

networks:
  scholarhub:

volumes:
  pg_data:
  redis_data:
  server_logs:
  server_uploads:
  admin_logs: