## 目标与范围

* 在个人中心左侧个人卡片右上角新增“设置”按钮，风格与现有 UI 保持一致、具备悬停与点击动效。

* 路由跳转至设置页面，平滑过渡且不刷新页面。

* 设置页面包含：头像上传（拖放/选择器+实时裁剪预览）、用户名修改（2–20 字长度与唯一性实时校验）、密码修改（强度指示与二次确认）、邮箱修改（格式校验与显示当前邮箱）。

* 文件分目录存储：`/uploads/profile`、`/uploads/questions`、`/uploads/resources`。

## UI 与交互设计

* 个人卡片设置按钮：放置于个人卡片右上角，图标使用齿轮（`Settings`），按钮为圆角、阴影与渐变悬停的 Material 风格；提供 `hover` 颜色变化与 `tap` 缩放动效。

* 路由与过渡：在 React Router 中新增 `"/profile/settings"` 路由；用 framer-motion 实现 page-level 淡入/淡出与轻微位移的过渡。

* 设置页面结构：四个分区（头像、用户名、密码、邮箱），保持响应式布局（两列栅格在桌面端，单列在移动端），各分区提供独立“保存”按钮与提示。

* 无障碍：为交互元素提供 `aria-label`、`role`、可聚焦顺序、键盘操作支持；错误信息以 `aria-live` 提示。

## 前端实现

* 文件与组件：

  * 修改 `client/src/pages/student/Profile.tsx`：在个人卡片右上角渲染“设置”按钮；点击后使用 `navigate('/profile/settings')`。

  * 新增 `client/src/pages/student/ProfileSettings.tsx`：封装四大模块与统一验证/提交逻辑，复用已有 Toast；使用 framer-motion 动画。

* 头像上传：

  * 原生拖放与文件选择器；类型仅限 `image/jpeg`、`image/png`；大小限制 ≤ 5MB。

  * 使用 `<canvas>` 实现中心方形裁剪预览；裁剪后生成 JPEG Blob；

  * 命名规则：`<userId>-<timestamp>.jpg/png`；上传到 `/uploads/profile/`；成功后调用后端保存头像 URL。

* 用户名修改：

  * 输入框限制 2–20 字符；正则校验 `^[A-Za-z0-9_\-\.]{2,20}$`；

  * 300ms 防抖实时唯一性校验（调用后端自查接口）；

  * 保存时调用现有 `PATCH /api/auth/username`，失败展示后端返回信息。

* 密码修改：

  * 实时强度指示器（颜色/文本）：至少 8 位且包含大小写字母与数字；

  * 二次确认一致性校验；

  * 保存时调用 `POST /api/auth/password`。

* 邮箱修改：

  * 显示当前邮箱；格式校验；

  * 新邮箱发起验证码（`POST /api/auth/email`）→ 输入验证码确认（`POST /api/auth/email/confirm`）。

* 校验与防抖：

  * 公共 `useDebouncedValue(300ms)` 钩子供用户名/邮箱输入实时校验；

  * 表单字段在 `onChange` 即时校验并显示错误提示。

* 路由动画：

  * 在 `App.tsx` 的 `Routes` 外层或页面根节点使用 `AnimatePresence` 实现平滑过渡。

## 后端实现

* 上传目录结构：

  * 修改/扩展 `server/src/routes/uploads.ts`：

    * 创建子目录：`uploads/profile`、`uploads/questions`、`uploads/resources`（Windows 上用默认创建；Linux 部署时设置 755 权限）。

    * 新增头像上传路由 `POST /api/uploads/avatar`：文件类型过滤（JPG/PNG）、大小 ≤5MB，保存到 `uploads/profile` 并返回 URL `/uploads/profile/<filename>`。

  * 现有资源上传仍走 `uploads/files`（保存到 `uploads/resources`）。

* 设置相关接口（保持与现有实现一致）：

  * `PATCH /api/auth/username`：沿用当前端点，前端前置校验 2–20 字，后端唯一性校验；

  * `POST /api/auth/password`：校验当前密码正确与新密码强度；

  * `POST /api/auth/avatar`：校验 URL 前缀 `/uploads/profile/` 并保存；

  * `POST /api/auth/email` 与 `POST /api/auth/email/confirm`：发送并校验 6 位验证码。

* 新增唯一性校验端点（可选）：

  * `GET /api/auth/username/check?u=<name>`：返回 `{ exists: boolean }`，供前端实时检测。

* 操作日志：在上述接口中追加 `settings.log` 记录（用户ID、操作类型、时间、结果）。

## 存储与权限

* 目录：`uploads/profile`、`uploads/questions`、`uploads/resources`；

* 权限：部署到 Linux 时以 `fs.chmodSync(dir, 0o755)` 设定；Windows 本地遵循默认 ACL；

* 命名规则：头像 `userId-timestamp.ext`；问题图片与资源文件按业务命名或随机名 + 扩展。

## 验证与安全

* 前后端双重校验：用户名长度与字符集、密码强度、邮箱格式与唯一性、头像 URL 校验；

* 身份校验：所有设置修改接口需登录；

* 速率限制：邮箱验证码发送在服务端设置 60s 冷却与 10 分钟有效期；

* XSS/注入：字符串做转义或限制字符集；

* 日志：敏感字段（密码）不写入明文日志。

## 性能与无障碍

* 防抖 300ms 减少重复校验请求；

* 大图裁剪在前端完成，传输裁剪后图片；

* 移动端自适应：两列栅格在小屏降为一列；

* 无障碍：键盘导航、aria 属性、焦点管理与可见错误提示。

## 测试与文档

* 单元测试（前端）：

  * 验证器（用户名/密码/邮箱），强度指示器逻辑；

  * 头像裁剪与上传流程（模拟 Blob）；

* 单元测试（后端）：

  * `/auth/password` 正常/错误路径；`/auth/username` 唯一性；`/auth/email*` 发送与确认；`/uploads/avatar` 类型与大小限制；

* 覆盖率目标 ≥ 80%；

* Swagger 文档补充：设置相关端点参数/响应示例；

* 组件使用说明：ProfileSettings 组件属性、依赖、示例。

## 交付物

* 完整 UI 方案（设置按钮与设置页面，含动效与响应式）；

* 可运行代码（前后端接口与页面集成）；

* 测试用例与模拟数据（前/后端）；

* 模块集成指南（如何在 Profile 中挂载按钮与路由、如何配置上传目录）。

## 实施顺序

1. 扩展上传路由与目录结构；2) 新增/完善设置相关后端端点；3) 前端新增设置页面与按钮；4) 接入验证/防抖/动效与无障碍；5) 编写测试与文档；6) 自测并交付。

